# 网络粘贴板服务端创建文档（Rust + Axum + MySQL）
以下是基于 **Rust + Axum + MySQL** 重构的服务端创建命令（完全适配需求文档，替换原 SQLite 为 MySQL，兼顾稳定性与多端访问支持），包含环境准备、项目搭建、数据库配置等完整步骤：


## 一、前置环境准备
### 1. 核心依赖安装
#### （1）安装 Rust 环境（1.75+，已安装可跳过）
```bash
# 安装 Rust（自动包含 cargo 包管理器）
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
# 安装完成后重启终端，验证版本
rustc --version  # 需 ≥ 1.75.0
cargo --version  # 需 ≥ 1.75.0
```

#### （2）安装 MySQL 服务（5.7+ 或 8.0+）
- **Ubuntu/Debian**：
  ```bash
  sudo apt update && sudo apt install mysql-server mysql-client libmysqlclient-dev
  # 启动 MySQL 并设置开机自启
  sudo systemctl start mysql
  sudo systemctl enable mysql
  # 初始化 root 密码（可选，根据系统提示操作）
  sudo mysql_secure_installation
  ```
- **macOS**：
  ```bash
  # 方式1：通过 brew 安装（推荐）
  brew install mysql
  # 启动 MySQL 并设置开机自启
  brew services start mysql
  # 初始化密码
  mysql_secure_installation
  ```
- **Windows**：
    1. 下载 MySQL 安装包（https://dev.mysql.com/downloads/mysql/）
    2. 安装时选择「Server Only」，设置 root 密码（记牢，后续配置需用）
    3. 确保 MySQL 服务启动（可在「服务」中查看 `MySQL80` 状态）

#### （3）验证 MySQL 可用性
```bash
# 登录 MySQL（输入之前设置的 root 密码）
mysql -u root -p
# 若登录成功，执行以下命令创建服务端专用数据库（关键步骤）
CREATE DATABASE clipboard_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
# 退出 MySQL
exit;
```


## 二、服务端项目创建 & 依赖安装
### 1. 初始化 Rust 项目
```bash
# 创建服务端项目目录（命名为 clipboard_server）
cargo new clipboard_server
cd clipboard_server
```

### 2. 添加核心依赖（适配 MySQL，一键执行）
```bash
# 核心 Web 框架 + 异步运行时
cargo add axum@0.7 tokio@1 --features "full"
# 数据库（MySQL）+ ORM
cargo add diesel@2.1 diesel_mysql_backend@2.1 mysql_connector_c@0.24
# 加密相关（修正 webpki-roots 包名）
cargo add bcrypt@0.15 aes-gcm@0.10 ring@0.17 rustls@0.21 webpki-roots@0.25
# 序列化 + JWT 认证
cargo add serde@1 serde_json@1 serde_derive@1 jsonwebtoken@9
# 工具类
cargo add dotenv@0.15 tracing@0.1 tracing-subscriber@0.3 chrono@0.4 uuid@1 --features "serde"
# HTTP 辅助（CORS、JSON 解析）
cargo add tower-http@0.5 --features "cors validate-requests json"
```

### 3. 安装数据库迁移工具（diesel_cli，适配 MySQL）
用于快速生成 MySQL 数据表（用户密码表、粘贴板内容表）：
```bash
# 安装 diesel_cli，指定 MySQL 特性（依赖系统 MySQL 客户端库）
cargo install diesel_cli --no-default-features --features mysql
```


## 三、MySQL 数据库配置 & 表结构创建
### 1. 创建环境变量配置文件
在项目根目录创建 `.env` 文件，配置 MySQL 连接信息（替换占位符为你的实际配置）：
```bash
# 终端执行（自动创建 .env 文件并写入配置）
cat > .env << EOF
# MySQL 连接 URL 格式：mysql://用户名:密码@主机:端口/数据库名?参数
DATABASE_URL=mysql://root:你的MySQL密码@localhost:3306/clipboard_db?charset=utf8mb4&collation=utf8mb4_unicode_ci
# JWT 密钥（用于认证，随机生成即可，建议至少 32 字符）
JWT_SECRET=your_random_jwt_secret_key_32chars_long_1234
# 服务端口（默认 3000）
SERVER_PORT=3000
EOF
```
- 替换 `你的MySQL密码` 为你安装 MySQL 时设置的 root 密码（如无密码，去掉 `:密码` 部分，即 `mysql://root@localhost:3306/...`）
- `JWT_SECRET` 可通过 `uuidgen` 命令（Linux/macOS）或在线 UUID 生成器获取，确保足够复杂

### 2. 初始化数据库迁移目录
```bash
# 生成 diesel 迁移模板（创建 migrations 文件夹，用于管理表结构）
diesel setup
# 新建迁移文件（命名为 create_users_and_clipboards，用于创建核心表）
diesel migration generate create_users_and_clipboards
```

### 3. 编写 MySQL 表结构（替换迁移文件内容）
执行上一步后，项目会生成 `migrations/[时间戳]_create_users_and_clipboards/` 目录，修改其中两个文件（适配 MySQL 语法）：

#### （1）修改 `up.sql`（创建表结构，核心文件）
```sql
-- 用户密码表（存储密码哈希，支持单用户多设备登录，需求文档「简单密码认证」）
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    password_hash VARCHAR(255) NOT NULL UNIQUE COMMENT 'bcrypt 哈希后的密码',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户密码表';

-- 粘贴板内容表（存储加密后的文本内容，支持多端同步）
CREATE TABLE clipboards (
    id INT AUTO_INCREMENT PRIMARY KEY,
    content TEXT NOT NULL COMMENT 'AES-256-GCM 加密后的内容（Base64 编码）',
    timestamp BIGINT NOT NULL COMMENT '客户端上传时间戳（毫秒）',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    INDEX idx_timestamp (timestamp DESC) COMMENT '按时间戳倒序索引，优化查询'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='粘贴板内容表';

-- 初始化默认用户（可选，便于测试，生产环境可删除）
-- 注意：以下密码哈希对应明文密码「12345678」，测试后请及时修改
INSERT INTO users (password_hash) VALUES ('$2b$12$EixZaYb4xU58Gpq1R0yWbeb00LU5qUaK6xW6X8h16QK6oB6iQ2G.q');
```

#### （2）修改 `down.sql`（回滚逻辑，用于删除表）
```sql
-- 回滚时删除表（顺序：先删依赖表，再删主表）
DROP TABLE IF EXISTS clipboards;
DROP TABLE IF EXISTS users;
```

### 4. 执行数据库迁移（创建表结构）
```bash
# 执行迁移，创建上述表结构（自动连接 .env 中的 MySQL 数据库）
diesel migration run
```
- 执行成功后，可登录 MySQL 验证表是否创建：
  ```bash
  mysql -u root -p
  USE clipboard_db;
  SHOW TABLES;  # 应显示 users 和 clipboards 两张表
  SELECT * FROM users;  # 应看到一条默认用户记录（若添加了 INSERT 语句）
  exit;
  ```


## 四、启动服务端（验证基础架构）
### 1. 替换 `src/main.rs` 为 MySQL 适配版代码
```rust
use axum::{routing::get, Router, Server};
use dotenv::dotenv;
use std::env;
use std::net::SocketAddr;
use tracing_subscriber::{layer::SubscriberExt, util::SubscriberInitExt};

// 数据库连接池（全局共享，适配 MySQL）
pub mod db {
    use diesel::mysql::MysqlConnection;
    use diesel::r2d2::{self, ConnectionManager, Pool};
    use dotenv::dotenv;
    use std::env;

    pub type DbPool = Pool<ConnectionManager<MysqlConnection>>;

    // 初始化数据库连接池
    pub fn init_pool() -> DbPool {
        dotenv().ok();
        let database_url = env::var("DATABASE_URL").expect("DATABASE_URL 未在 .env 中配置");
        let manager = ConnectionManager::<MysqlConnection>::new(database_url);
        Pool::builder()
            .build(manager)
            .expect("无法创建 MySQL 连接池")
    }
}

#[tokio::main]
async fn main() {
    // 初始化日志（便于调试）
    tracing_subscriber::registry()
        .with(tracing_subscriber::EnvFilter::from_default_env())
        .with(tracing_subscriber::fmt::layer())
        .init();

    // 加载环境变量
    dotenv().ok();

    // 初始化 MySQL 连接池
    let pool = db::init_pool();
    tracing::info!("MySQL 连接池初始化成功 ✅");

    // 路由配置（基础健康检查接口 + 共享数据库连接池）
    let app = Router::new()
        .route("/health", get(health_check))
        .with_state(pool)  // 全局共享数据库连接池
        .layer(tower_http::cors::CorsLayer::permissive());  // 允许跨域（开发环境）

    // 从环境变量读取服务端口（默认 3000）
    let port = env::var("SERVER_PORT")
        .unwrap_or_else(|_| "3000".to_string())
        .parse()
        .expect("SERVER_PORT 必须是数字");
    let addr = SocketAddr::from(([0, 0, 0, 0], port));  // 0.0.0.0 允许外部设备访问

    tracing::info!("服务端启动成功，地址：http://{}", addr);

    // 启动服务
    Server::bind(&addr)
        .serve(app.into_make_svc())
        .await
        .unwrap();
}

// 健康检查接口（用于前端测试连接 + 数据库可用性）
async fn health_check(pool: db::DbPool) -> &'static str {
    // 尝试从连接池获取连接，验证数据库可用性
    let _conn = pool.get().expect("无法连接到 MySQL 数据库");
    "服务端正常运行 + MySQL 连接成功 ✅"
}
```

### 2. 启动服务端
```bash
# 编译并启动（首次启动会下载依赖，耐心等待）
cargo run
```

### 3. 验证服务可用性
#### （1）本地验证
打开浏览器或终端执行：
```bash
curl http://127.0.0.1:3000/health
```
若返回 `服务端正常运行 + MySQL 连接成功 ✅`，说明服务端 + MySQL 配置成功！

#### （2）跨设备验证（可选）
若需手机/其他电脑访问服务端：
1. 确保服务端和设备在同一局域网
2. 替换服务端 `src/main.rs` 中的监听地址为 `0.0.0.0:3000`（已在代码中配置）
3. 在其他设备上执行 `curl http://服务端IP:3000/health`（服务端IP可通过 `ifconfig`/`ip addr` 查询）


## 五、核心接口开发（适配需求文档功能）
服务端基础架构搭建完成后，需继续实现以下核心接口（基于 Axum + Diesel + MySQL），对应需求文档的功能模块：

### 1. 密码认证接口
| 接口路径               | 方法 | 功能描述                  | 请求体/参数                  | 响应体                          |
|------------------------|------|---------------------------|------------------------------|---------------------------------|
| `/api/auth/set-password` | POST | 首次设置密码（覆盖旧密码） | `{ "password": "新密码" }`   | `{ "success": true, "msg": "密码设置成功" }` |
| `/api/auth/login`      | POST | 密码登录（获取 JWT 令牌） | `{ "password": "输入密码" }` | `{ "success": true, "token": "JWT令牌" }` |
| `/api/auth/change-password` | POST | 修改密码 | `{ "old_password": "旧密码", "new_password": "新密码" }` | `{ "success": true, "msg": "密码修改成功" }` |

### 2. 粘贴板同步接口
| 接口路径                   | 方法 | 功能描述                  | 请求头（必须）               | 请求体/参数                  | 响应体                          |
|----------------------------|------|---------------------------|------------------------------|------------------------------|---------------------------------|
| `/api/clipboard/sync`      | POST | 上传内容到服务端          | `Authorization: Bearer JWT令牌` | `{ "content": "加密内容", "timestamp": 123456789 }` | `{ "success": true, "id": 1 }` |
| `/api/clipboard/history`   | GET  | 获取所有历史同步内容      | `Authorization: Bearer JWT令牌` | 无（可选参数 `limit=100`）  | `{ "success": true, "data": [{"id":1, "content":"加密内容", "timestamp":123456789}] }` |
| `/api/clipboard/:id`       | DELETE | 删除指定内容              | `Authorization: Bearer JWT令牌` | 无（路径参数 `id`）          | `{ "success": true, "msg": "删除成功" }` |

### 接口实现关键注意事项
1. **JWT 认证**：所有接口（除 `/health`、`/api/auth/login`、`/api/auth/set-password`）需验证 JWT 令牌，无效令牌返回 401 错误
2. **内容加密**：服务端存储的 `content` 是客户端 AES-256-GCM 加密后的 Base64 字符串，服务端不解密，仅负责存储和同步
3. **密码验证**：登录时用 bcrypt 算法验证输入密码与数据库中 `password_hash` 是否匹配
4. **跨域配置**：生产环境需替换 `CorsLayer::permissive()` 为严格的跨域规则（仅允许前端 App 域名访问）


## 六、生产环境部署建议
### 1. 安全配置
- **HTTPS 强制**：使用 Let's Encrypt 申请免费 TLS 证书，配置 Axum 启用 HTTPS（可参考 `axum-rustls` 依赖）
- **MySQL 权限控制**：创建专用数据库用户（非 root），仅授予 `clipboard_db` 数据库的 `SELECT/INSERT/UPDATE/DELETE` 权限
  ```sql
  CREATE USER 'clipboard_user'@'localhost' IDENTIFIED BY '强密码';
  GRANT SELECT, INSERT, UPDATE, DELETE ON clipboard_db.* TO 'clipboard_user'@'localhost';
  FLUSH PRIVILEGES;
  ```
  然后修改 `.env` 中的 `DATABASE_URL` 为 `mysql://clipboard_user:强密码@localhost:3306/clipboard_db`
- **JWT 密钥更新**：生产环境定期更换 `JWT_SECRET`，避免密钥泄露

### 2. 性能优化
- **数据库连接池**：调整 `Pool::builder()` 中的参数（如 `max_size=10`），适配并发量
- **日志级别**：生产环境设置日志级别为 `INFO` 或 `WARN`，减少日志开销
- **进程守护**：使用 `systemd`（Linux）或 `PM2` 守护服务进程，防止服务意外退出

### 3. 数据备份
定期备份 MySQL 数据库（避免数据丢失）：
```bash
# 手动备份（替换用户名和数据库名）
mysqldump -u clipboard_user -p clipboard_db > clipboard_backup_$(date +%Y%m%d).sql
# 定时备份（添加到 crontab，每天凌晨 2 点执行）
0 2 * * * mysqldump -u clipboard_user -p'强密码' clipboard_db > /path/to/backup/clipboard_backup_$(date +%Y%m%d).sql
```


## 关键问题排查
1. **diesel_cli 安装失败**：
    - 确保系统已安装 MySQL 客户端库（如 `libmysqlclient-dev`）
    - Windows 需手动指定 MySQL 安装路径：`set MYSQLCLIENT_LIB_DIR=C:\Program Files\MySQL\MySQL Server 8.0\lib` 后再安装 diesel_cli

2. **数据库连接失败**：
    - 检查 `.env` 中 `DATABASE_URL` 的用户名、密码、端口是否正确
    - 确保 MySQL 服务已启动（`sudo systemctl status mysql`）
    - 若为远程 MySQL，需开启 3306 端口防火墙，并允许远程访问（修改 MySQL 配置文件 `bind-address = 0.0.0.0`）

3. **跨端访问失败**：
    - 检查服务端防火墙是否开放 3000 端口（`sudo ufw allow 3000`）
    - 确保设备在同一局域网，且服务端监听地址为 `0.0.0.0:3000`


通过以上步骤，即可搭建一个基于 MySQL 的稳定服务端，后续可结合需求文档逐步实现核心接口，与 Tauri 前端配合完成跨端网络粘贴板功能。